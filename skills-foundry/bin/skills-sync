#!/usr/bin/env python3
from __future__ import annotations

import argparse
import datetime as dt
from pathlib import Path

from _skills_common import FOUNDRY_ROOT, REPORTS_ROOT
from _skills_sync_render import (
    apply_sync,
    build_sync_plan,
    print_sync_plan,
    run_validate_and_lint_for_sync,
)


def _default_target() -> Path:
    return Path.home() / ".codex" / "skills"


def _default_backup_dir() -> Path:
    stamp = dt.datetime.now(dt.timezone.utc).strftime("%Y%m%dT%H%M%SZ")
    return Path.home() / ".codex" / "skills-backups" / stamp


def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(
        prog=Path(__file__).name,
        description="Validate, lint, and sync skills into a target ~/.codex/skills directory.",
    )
    parser.add_argument("--from", dest="from_root", type=Path, default=FOUNDRY_ROOT / "skills")
    parser.add_argument("--to", dest="to_root", type=Path, default=_default_target())
    parser.add_argument("--dry-run", action="store_true")
    parser.add_argument("--backup-dir", type=Path)
    parser.add_argument("--strategy", choices=["copy", "symlink"], default="copy")
    parser.add_argument("--only", action="append", default=[], dest="only_ids")
    parser.add_argument("--prune", action="store_true")
    parser.add_argument("--yes", action="store_true", help="Confirm destructive actions such as pruning")
    parser.add_argument("--reports-dir", type=Path, default=REPORTS_ROOT)
    parser.add_argument("--repo-root", type=Path, default=FOUNDRY_ROOT.parent)
    return parser


def main() -> int:
    parser = build_parser()
    args = parser.parse_args()

    if args.prune and not args.yes:
        print("ERROR: --prune requires confirmation via --yes")
        return 2
    if args.prune and args.only_ids:
        print("ERROR: --prune cannot be combined with --only in this implementation")
        return 2

    backup_dir = args.backup_dir or _default_backup_dir()

    print("Running skills-validate and skills-lint before sync...")
    try:
        entries, _lint_results = run_validate_and_lint_for_sync(
            skills_root=args.from_root,
            repo_root=args.repo_root,
            reports_dir=args.reports_dir,
        )
    except RuntimeError as exc:
        print(f"ERROR: {exc}")
        return 1

    plan = build_sync_plan(entries, target_root=args.to_root, only_ids=args.only_ids, prune=args.prune)
    print_sync_plan(plan)

    if args.dry_run:
        print("Dry-run: no files were written")
        return 0

    apply_sync(
        entries=entries,
        plan=plan,
        target_root=args.to_root,
        strategy=args.strategy,
        backup_dir=backup_dir,
        prune=args.prune,
        dry_run=False,
    )
    print(f"Sync complete: target={args.to_root}")
    if plan.create or plan.update or plan.would_prune:
        print(f"Backups (if any) written under: {backup_dir}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
