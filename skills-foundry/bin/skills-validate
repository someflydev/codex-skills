#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
from pathlib import Path

from _skills_common import FOUNDRY_ROOT, SKILLS_ROOT, format_validate_summary, validate_skills, validation_failed


def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(
        prog=Path(__file__).name,
        description="Validate skills under skills/**/SKILL.md for front matter and required sections.",
    )
    parser.add_argument("--skills-root", type=Path, default=SKILLS_ROOT)
    parser.add_argument("--repo-root", type=Path, default=FOUNDRY_ROOT.parent)
    parser.add_argument("--json", dest="json_out", type=Path, help="Optional path to write validation details JSON")
    return parser


def main() -> int:
    parser = build_parser()
    args = parser.parse_args()

    docs = validate_skills(args.skills_root, args.repo_root)
    if not docs:
        print(f"Validated 0 skills: no SKILL.md files found under {args.skills_root}")
    else:
        print(format_validate_summary(docs))

    if args.json_out:
        args.json_out.parent.mkdir(parents=True, exist_ok=True)
        payload = []
        for doc in docs:
            payload.append(
                {
                    "skill_id": doc.skill_id,
                    "path": str(doc.path),
                    "messages": [
                        {"level": m.level, "code": m.code, "message": m.message} for m in doc.messages
                    ],
                }
            )
        args.json_out.write_text(json.dumps(payload, indent=2) + "\n", encoding="utf-8")

    return 1 if validation_failed(docs) else 0


if __name__ == "__main__":
    raise SystemExit(main())
